<div class="container mx-auto p-4 md:p-6 mt-4 mb-4 bg-gradient-to-br from-blue-50 via-white to-sky-50 rounded-2xl border border-blue-100 shadow-2xl">
  @if (isOpenPopup) {
    <app-popup
      [message]="popupMessage"
      [type]="popupType"
      (onClose)="closePopup()"
    ></app-popup>
  }
  @if (isTicketModalOpen) {
    <div class="fixed inset-0 z-[110] flex items-center justify-center p-4" (click)="closeTicketModal()">
      <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
      <div class="relative rounded-2xl w-full max-w-4xl p-4"
          (click)="$event.stopPropagation()">
        @if (selectedTickets) {
          <app-ticket
            [items]="selectedTickets">
          </app-ticket>
        } @else if (selectedTicket) {
          <app-ticket
            [item]="selectedTicket">
          </app-ticket>
        }
      </div>
    </div>
  }
  <div class="hero bg-gradient-to-r from-blue-50 via-blue-100 to-sky-100 text-blue-900 rounded-xl mb-8 shadow-2xl border border-blue-200">
    <div class="hero-content text-center py-12">
      <div class="max-w-2xl">
        <div class="avatar mb-4">
          <div class="w-24 h-24 rounded-full overflow-hidden border-4 border-white shadow-xl relative cursor-pointer group" (click)="openPhotoUpdatePopup()">
            <!-- Placeholder SVG persona -->
            @if (!imageLoaded) {
              <div class="w-full h-full bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center z-10">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-12 text-blue-400">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                </svg>
              </div>
            }
            <img
              [src]="getPhotoUrl()"
              (load)="onImageLoad()"
              (error)="onImageError()"
              class="w-full h-full object-cover absolute inset-0 transition-opacity duration-500"
              [class.opacity-100]="imageLoaded"
              [class.opacity-0]="!imageLoaded" />
            <div class="absolute inset-0 bg-black opacity-0 group-hover:opacity-30 transition-all duration-300 flex items-center justify-center rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="white" class="w-6 h-6 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
              </svg>
            </div>
          </div>
        </div>
        <h1 class="text-4xl font-bold mb-2">{{ passengerInfo?.nome }}</h1>
        @if(passengerInfo?.sesso === 'F') {
          <p class="text-xl opacity-80 mb-4">Viaggiatrice Frequente</p>
        } @else {
          <p class="text-xl opacity-80 mb-4">Viaggiatore Frequente</p>
        }
        <div class="flex justify-center gap-4 text-sm">
          @if (currentLevel) {
            <div class="badge bg-blue-600 text-white border-0 badge-lg shadow-lg font-bold">{{ currentLevel }} Member</div>
          }
          @if (passengerStatistics?.kilometersFlown) {
            <div class="badge bg-blue-500 text-white border-0 badge-lg shadow-lg font-bold">{{ passengerStatistics?.kilometersFlown }} Chilometri</div>
          }
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2 space-y-6">
      <div class="card bg-white border border-blue-100 shadow-2xl">
        <div class="card-body bg-gradient-to-br from-blue-50 via-white to-sky-50 rounded-2xl">
          <h2 class="card-title text-2xl mb-4 text-blue-900">
            Informazioni Personali
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
              <div class="mb-2">
                <span class="label-text font-semibold text-blue-800">Nome</span>
              </div>
              <input type="text" value="{{ passengerInfo?.nome }}" class="input input-bordered border-blue-200 focus:border-blue-500 bg-white" readonly />
            </div>
            <div class="form-control">
              <div class="mb-2">
                <span class="label-text font-semibold text-blue-800">Cognome</span>
              </div>
              <input type="text" value="{{ passengerInfo?.cognome }}" class="input input-bordered border-blue-200 focus:border-blue-500 bg-white" readonly />
            </div>
            <div class="form-control">
              <div class="mb-2">
                <span class="label-text font-semibold text-blue-800">Codice Fiscale</span>
              </div>
              <input type="text" value="{{ passengerInfo?.codice_fiscale }}" class="input input-bordered border-blue-200 focus:border-blue-500 bg-white" readonly />
            </div>
            <div class="form-control">
              <div class="mb-2">
                <label class="label">
                  <span class="label-text font-semibold text-blue-800">Sesso</span>
                </label>
              </div>
              @if(passengerInfo?.sesso === 'M') {
                <input type="text" value="Maschio" class="input input-bordered border-blue-200 focus:border-blue-500 bg-white" readonly />
              } @else if(passengerInfo?.sesso === 'F') {
                <input type="text" value="Femmina" class="input input-bordered border-blue-200 focus:border-blue-500 bg-white" readonly />
              } @else {
                <input type="text" value="Altro" class="input input-bordered border-blue-200 focus:border-blue-500 bg-white" readonly />
              }
            </div>
            <div class="form-control">
              <div class="mb-2">
                <label class="label">
                  <span class="label-text font-semibold text-blue-800">Data di Nascita</span>
                </label>
              </div>
              <input type="date" [value]="getBirthDate()" class="input input-bordered border-blue-200 focus:border-blue-500 bg-white" readonly />
            </div>
          </div>
        </div>
      </div>
      <div class="card bg-white border border-blue-100 shadow-2xl">
        <div class="card-body bg-gradient-to-br from-blue-50 via-white to-sky-50 rounded-2xl">
          <h2 class="card-title text-2xl mb-4 text-blue-900">
            Sicurezza Account
          </h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <form (ngSubmit)="onSubmitEmail()"> 
              <!-- Email Section -->
              <div>
                <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-blue-800">
                  Email
                </h3>
                <div class="space-y-3">
                  <input type="email" value="{{ passengerInfo?.email }}" class="input input-bordered border-blue-200 focus:border-blue-500 bg-white input-sm w-full" readonly />
                  <input type="email" [(ngModel)]="email" name="email" placeholder="Nuova email" class="input input-bordered border-blue-200 focus:border-blue-500 bg-white input-sm w-full" />
                  <button type="submit" [disabled]="!isValidEmail(email)" class="btn bg-blue-600 hover:bg-blue-700 text-white border-0 shadow-lg btn-sm w-full">Aggiorna Email</button>
                </div>
              </div>
            </form>

            <form (ngSubmit)="onSubmitPassword()">
              <div>
                <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-blue-800">
                  Password
                </h3>
                <div class="space-y-3">
                  <input type="password" [(ngModel)]="passwordAttuale" name="passwordAttuale" placeholder="Password attuale" class="input input-bordered border-blue-200 focus:border-blue-500 bg-white input-sm w-full" />
                  <input type="password" [(ngModel)]="nuovaPassword" name="nuovaPassword" placeholder="Nuova password" class="input input-bordered border-blue-200 focus:border-blue-500 bg-white input-sm w-full" />
                  <button type="submit" [disabled]="!passwordAttuale || !nuovaPassword" class="btn bg-orange-600 hover:bg-orange-700 text-white border-0 shadow-lg btn-sm w-full">Aggiorna Password</button>
                </div>
              </div>
            </form>
          </div>
          <div class="mt-6 pt-4 border-t border-blue-200">
            <div class="form-control">
              <label class="label cursor-pointer justify-start gap-3">
                <input type="checkbox" class="checkbox bg-blue-50 border-2 border-blue-200 checked:bg-blue-600 checked:border-blue-600 w-6 h-6 transition-all duration-200" />
                <div>
                  <span class="label-text font-medium text-blue-800">Autenticazione a Due Fattori (2FA)</span>
                  <div class="text-xs text-blue-600">Maggiore sicurezza per il tuo account</div>
                </div>
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="card bg-white border border-blue-100 shadow-2xl">
      <div class="card-body bg-gradient-to-br from-blue-50 via-white to-sky-50 rounded-2xl">
        <div class="flex justify-between items-center mb-4">
          <h2 class="card-title text-2xl text-blue-900">
            Le Mie Prenotazioni
          </h2>
        </div>
      <div class="space-y-4 max-h-106 overflow-y-auto pr-2">
        @if (reservationGroups.length === 0) {
          <div class="alert bg-blue-50 border-2 border-blue-200">
            <span class="text-blue-700">Nessuna prenotazione trovata.</span>
          </div>
        } @else {
          @for (g of reservationGroups; track g.key) {
            <div class="card border-2 bg-blue-50 border-blue-200 shadow-lg">
              <div class="card-body p-4">
                <div class="flex justify-between items-start mb-3">
                  <div class="flex-1">
                    <div class="flex flex-wrap items-center gap-2 mb-1">
                      @if (isGroupPast(g)) {
                        <div class="badge bg-gray-500 text-white border-0 text-xs sm:text-sm font-bold">
                          Completato
                        </div>
                      } @else {
                        <div class="badge badge-success text-white font-bold text-xs sm:text-sm">
                          In partenza
                        </div>
                      }
                      <div class="badge bg-blue-200 text-blue-900 border-0 text-xs sm:text-sm font-bold">
                        {{ g.tickets.length }} bigliett{{ g.tickets.length > 1 ? 'i' : 'o' }}
                      </div>
                    </div>
                    <h3 class="font-bold text-blue-900">
                      {{ g.cityFrom || g.from }} ‚Üí {{ g.cityTo || g.to }}
                    </h3>
                    <p class="text-sm text-blue-600">
                      {{ g.flightNumber }}
                      @if (g.departureDate) { ‚Ä¢ {{ g.departureDate }} }
                      @if (g.departureTime) { ‚Ä¢ {{ g.departureTime }} }
                    </p>
                  </div>
                  <div class="flex gap-2 justify-end self-center">
                    <button
                      class="btn btn-sm border-2 bg-blue-600 hover:bg-blue-700 border-blue-700 text-white shadow-lg mt-2"
                      (click)="openTicketModal(g.tickets)">
                      Dettagli
                    </button>
                  </div>
                </div>
              </div>
            </div>
          }
        }
      </div>
    </div>
  </div>
    </div>
    <div class="space-y-6">
      <div class="card bg-white border border-blue-100 shadow-2xl">
        <div class="card-body bg-gradient-to-br from-blue-50 via-white to-sky-50 rounded-2xl">
          <h3 class="card-title mb-4 text-blue-900">
            Programma Fedelt√†
          </h3>
          <div class="text-center mb-4">
            <div class="radial-progress text-blue-600" [style.--value]="getProgressPercentage()" role="progressbar">{{ getProgressPercentage() }}%</div>
            <p class="text-sm text-blue-600 mt-2">Verso {{ getNextLevel() }}</p>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-blue-800">Chilometri Attuali</span>
              <div class="text-sm font-medium text-blue-800">{{ passengerStatistics?.kilometersFlown }} km</div>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-blue-800">Chilometri per {{ getNextLevel() }}</span>
              <div class="text-sm font-medium text-blue-800">{{ getKmForNextLevel() }} km</div>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-blue-800">Voli Quest'Anno</span>
              <div class="text-sm font-medium text-blue-800">{{ passengerStatistics?.flightsThisYear }}</div>
            </div>
          </div>
        </div>
      </div>
      <div class="card bg-white border border-blue-100 shadow-2xl">
        <div class="card-body bg-gradient-to-br from-blue-50 via-white to-sky-50 rounded-2xl">
          <div class="flex items-center justify-between mb-4">
            <h3 class="card-title text-blue-900">
              Metodi di Pagamento
            </h3>
            <button class="btn btn-sm bg-blue-600 hover:bg-blue-700 text-white border-0 shadow-lg rounded-xl"
                    (click)="openAddMethodModal()">Aggiungi</button>
          </div>
          <div class="space-y-3">
            @if (stripeMethods.length === 0) {
              <div class="alert bg-blue-50 border-2 border-blue-200">
                <span class="text-blue-700">Nessun metodo salvato.</span>
              </div>
            } @else {
              @for (m of stripeMethods; track m.id) {
                <div class="flex items-center justify-between p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <div class="flex items-center gap-3">
                    @if(m.brand === 'visa') {
                      <svg class="size-9" viewBox="0 -140 780 780" enable-background="new 0 0 780 500" version="1.1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg"><path d="M40,0h700c22.092,0,40,17.909,40,40v420c0,22.092-17.908,40-40,40H40c-22.091,0-40-17.908-40-40V40   C0,17.909,17.909,0,40,0z" fill="#0E4595"/><path d="m293.2 348.73l33.361-195.76h53.36l-33.385 195.76h-53.336zm246.11-191.54c-10.57-3.966-27.137-8.222-47.822-8.222-52.725 0-89.865 26.55-90.18 64.603-0.299 28.13 26.514 43.822 46.752 53.186 20.771 9.595 27.752 15.714 27.654 24.283-0.131 13.121-16.586 19.116-31.922 19.116-21.357 0-32.703-2.967-50.227-10.276l-6.876-3.11-7.489 43.823c12.463 5.464 35.51 10.198 59.438 10.443 56.09 0 92.5-26.246 92.916-66.882 0.199-22.269-14.016-39.216-44.801-53.188-18.65-9.055-30.072-15.099-29.951-24.268 0-8.137 9.668-16.839 30.557-16.839 17.449-0.27 30.09 3.535 39.938 7.5l4.781 2.26 7.232-42.429m137.31-4.223h-41.232c-12.773 0-22.332 3.487-27.941 16.234l-79.244 179.4h56.031s9.16-24.123 11.232-29.418c6.125 0 60.555 0.084 68.338 0.084 1.596 6.853 6.49 29.334 6.49 29.334h49.514l-43.188-195.64zm-65.418 126.41c4.412-11.279 21.26-54.723 21.26-54.723-0.316 0.522 4.379-11.334 7.074-18.684l3.605 16.879s10.219 46.729 12.354 56.528h-44.293zm-363.3-126.41l-52.24 133.5-5.567-27.13c-9.725-31.273-40.025-65.155-73.898-82.118l47.766 171.2 56.456-0.064 84.004-195.39h-56.521" fill="#ffffff"/><path d="m146.92 152.96h-86.041l-0.681 4.073c66.938 16.204 111.23 55.363 129.62 102.41l-18.71-89.96c-3.23-12.395-12.597-16.094-24.186-16.527" fill="#F2AE14"/></svg>
                    } @else if(m.brand === 'mastercard') {
                      <svg class="size-9" viewBox="0 -11 70 70" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="0.5" y="0.5" width="69" height="47" rx="5.5" fill="white" stroke="#D9D9D9"/>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M35.3945 34.7619C33.0114 36.8184 29.92 38.0599 26.5421 38.0599C19.0047 38.0599 12.8945 31.8788 12.8945 24.254C12.8945 16.6291 19.0047 10.448 26.5421 10.448C29.92 10.448 33.0114 11.6895 35.3945 13.7461C37.7777 11.6895 40.869 10.448 44.247 10.448C51.7843 10.448 57.8945 16.6291 57.8945 24.254C57.8945 31.8788 51.7843 38.0599 44.247 38.0599C40.869 38.0599 37.7777 36.8184 35.3945 34.7619Z" fill="#ED0006"/>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M35.3945 34.7619C38.3289 32.2296 40.1896 28.4616 40.1896 24.254C40.1896 20.0463 38.3289 16.2783 35.3945 13.7461C37.7777 11.6895 40.869 10.448 44.247 10.448C51.7843 10.448 57.8945 16.6291 57.8945 24.254C57.8945 31.8788 51.7843 38.0599 44.247 38.0599C40.869 38.0599 37.7777 36.8184 35.3945 34.7619Z" fill="#F9A000"/>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M35.3946 13.7461C38.329 16.2784 40.1897 20.0463 40.1897 24.254C40.1897 28.4616 38.329 32.2295 35.3946 34.7618C32.4603 32.2295 30.5996 28.4616 30.5996 24.254C30.5996 20.0463 32.4603 16.2784 35.3946 13.7461Z" fill="#FF5E00"/>
                      </svg>
                    } @else if(m.brand === 'amex') {
                      <svg class="size-9" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
                            viewBox="0 0 512 512" xml:space="preserve">
                          <path style="fill:#306FC5;" d="M512,402.281c0,16.716-13.55,30.267-30.265,30.267H30.265C13.55,432.549,0,418.997,0,402.281V109.717
                            c0-16.715,13.55-30.266,30.265-30.266h451.47c16.716,0,30.265,13.551,30.265,30.266V402.281L512,402.281z"/>
                          <path style="opacity:0.15;fill:#202121;enable-background:new    ;" d="M21.517,402.281V109.717
                            c0-16.715,13.552-30.266,30.267-30.266h-21.52C13.55,79.451,0,93.001,0,109.717v292.565c0,16.716,13.55,30.267,30.265,30.267h21.52
                            C35.07,432.549,21.517,418.997,21.517,402.281z"/>
                          <g>
                            <polygon style="fill:#FFFFFF;" points="74.59,220.748 89.888,220.748 82.241,201.278 	"/>
                            <polygon style="fill:#FFFFFF;" points="155.946,286.107 155.946,295.148 181.675,295.148 181.675,304.885 155.946,304.885 
                              155.946,315.318 184.455,315.318 197.666,300.712 185.151,286.107 	"/>
                            <polygon style="fill:#FFFFFF;" points="356.898,201.278 348.553,220.748 364.548,220.748 	"/>
                            <polygon style="fill:#FFFFFF;" points="230.348,320.875 230.348,281.241 212.268,300.712 	"/>
                            <path style="fill:#FFFFFF;" d="M264.42,292.368c-0.696-4.172-3.48-6.261-7.654-6.261h-14.599v12.516h15.299
                              C261.637,298.624,264.42,296.539,264.42,292.368z"/>
                            <path style="fill:#FFFFFF;" d="M313.09,297.236c1.391-0.697,2.089-2.785,2.089-4.867c0.696-2.779-0.698-4.172-2.089-4.868
                              c-1.387-0.696-3.476-0.696-5.559-0.696h-13.91v11.127h13.909C309.613,297.932,311.702,297.932,313.09,297.236z"/>
                            <path style="fill:#FFFFFF;" d="M413.217,183.198v8.344l-4.169-8.344H376.37v8.344l-4.174-8.344h-44.502
                              c-7.648,0-13.909,1.392-19.469,4.173v-4.173h-31.289v0.696v3.477c-3.476-2.78-7.648-4.173-13.211-4.173h-111.95l-7.652,17.384
                              l-7.647-17.384h-25.031h-10.431v8.344l-3.477-8.344h-0.696H66.942l-13.909,32.68L37.042,251.34l-0.294,0.697h0.294h35.463h0.444
                              l0.252-0.697l4.174-10.428h9.039l4.172,11.125h40.326v-0.697v-7.647l3.479,8.343h20.163l3.475-8.343v7.647v0.697h15.993h79.965
                              h0.696v-18.08h1.394c1.389,0,1.389,0,1.389,2.087v15.297h50.065v-4.172c4.172,2.089,10.426,4.172,18.771,4.172h20.863l4.172-11.123
                              h9.732l4.172,11.123h40.328v-6.952v-3.476l6.261,10.428h1.387h0.698h30.595v-68.143h-31.291l0,0H413.217z M177.501,241.609h-6.955
                              h-4.171v-4.169v-34.076l-0.696,1.595v-0.019l-16.176,36.669h-0.512h-3.719h-6.017l-16.687-38.245v38.245h-23.64l-4.867-10.43
                              H70.417l-4.868,10.43H53.326l20.57-48.675h17.382l19.469,46.587v-46.587h4.171h14.251l0.328,0.697h0.024l8.773,19.094l6.3,14.306
                              l0.223-0.721l13.906-33.375H177.5v48.674H177.501L177.501,241.609z M225.481,203.364h-27.119v9.039h26.423v9.734h-26.423v9.738
                              h27.119v10.427h-38.939v-49.367h38.939V203.364L225.481,203.364z M275.076,221.294c0.018,0.016,0.041,0.027,0.063,0.042
                              c0.263,0.278,0.488,0.557,0.68,0.824c1.332,1.746,2.409,4.343,2.463,8.151c0.004,0.066,0.007,0.131,0.011,0.197
                              c0,0.038,0.007,0.071,0.007,0.11c0,0.022-0.002,0.039-0.002,0.06c0.016,0.383,0.026,0.774,0.026,1.197v9.735h-10.428v-5.565
                              c0-2.781,0-6.954-2.089-9.735c-0.657-0.657-1.322-1.09-2.046-1.398c-1.042-0.675-3.017-0.686-6.295-0.686h-12.52v17.384h-11.818
                              v-48.675h26.425c6.254,0,10.428,0,13.906,2.086c3.407,2.046,5.465,5.439,5.543,10.812c-0.161,7.4-4.911,11.46-8.326,12.829
                              C270.676,218.662,272.996,219.129,275.076,221.294z M298.491,241.609h-11.822v-48.675h11.822V241.609z M434.083,241.609h-15.3
                              l-22.25-36.855v30.595l-0.073-0.072v6.362h-11.747v-0.029h-11.822l-4.172-10.43H344.38l-4.172,11.123h-13.211
                              c-5.559,0-12.517-1.389-16.687-5.561c-4.172-4.172-6.256-9.735-6.256-18.773c0-6.953,1.389-13.911,6.256-19.472
                              c3.474-4.175,9.735-5.562,17.382-5.562h11.128v10.429h-11.128c-4.172,0-6.254,0.693-9.041,2.783
                              c-2.082,2.085-3.474,6.256-3.474,11.123c0,5.564,0.696,9.04,3.474,11.821c2.091,2.089,4.87,2.785,8.346,2.785h4.867l15.991-38.243
                              h6.957h10.428l19.472,46.587v-2.376v-15.705v-1.389v-27.116h17.382l20.161,34.07v-34.07h11.826v47.977h0.002L434.083,241.609
                              L434.083,241.609z"/>
                            <path style="fill:#FFFFFF;" d="M265.161,213.207c0.203-0.217,0.387-0.463,0.543-0.745c0.63-0.997,1.352-2.793,0.963-5.244
                              c-0.016-0.225-0.057-0.433-0.105-0.634c-0.013-0.056-0.011-0.105-0.026-0.161l-0.007,0.001c-0.346-1.191-1.229-1.923-2.11-2.367
                              c-1.394-0.693-3.48-0.693-5.565-0.693h-13.909v11.127h13.909c2.085,0,4.172,0,5.565-0.697c0.209-0.106,0.395-0.25,0.574-0.413
                              l0.002,0.009C264.996,213.389,265.067,213.315,265.161,213.207z"/>
                            <path style="fill:#FFFFFF;" d="M475.105,311.144c0-4.867-1.389-9.736-3.474-13.212v-31.289h-0.032v-2.089c0,0-29.145,0-33.483,0
                              c-4.336,0-9.598,4.171-9.598,4.171v-4.171h-31.984c-4.87,0-11.124,1.392-13.909,4.171v-4.171h-57.016v2.089v2.081
                              c-4.169-3.474-11.824-4.171-15.298-4.171h-37.549v2.089v2.081c-3.476-3.474-11.824-4.171-15.998-4.171H215.05l-9.737,10.431
                              l-9.04-10.431h-2.911h-4.737h-54.93v2.089v5.493v62.651h61.19l10.054-10.057l8.715,10.057h0.698h35.258h1.598h0.696h0.692v-6.953
                              v-9.039h3.479c4.863,0,11.124,0,15.991-2.089v17.382v1.394h31.291v-1.394V317.4h1.387c2.089,0,2.089,0,2.089,2.086v14.6v1.394
                              h94.563c6.263,0,12.517-1.394,15.993-4.175v2.781v1.394h29.902c6.254,0,12.517-0.695,16.689-3.478
                              c6.402-3.841,10.437-10.64,11.037-18.749c0.028-0.24,0.063-0.48,0.085-0.721l-0.041-0.039
                              C475.087,312.043,475.105,311.598,475.105,311.144z M256.076,306.973h-13.91v2.081v4.174v4.173v7.649h-22.855l-13.302-15.299
                              l-0.046,0.051l-0.65-0.748l-15.297,15.996h-44.501v-48.673h45.197l12.348,13.525l2.596,2.832l0.352-0.365l14.604-15.991h36.852
                              c7.152,0,15.161,1.765,18.196,9.042c0.365,1.441,0.577,3.043,0.577,4.863C276.237,304.189,266.502,306.973,256.076,306.973z
                              M325.609,306.276c1.389,2.081,2.085,4.867,2.085,9.041v9.732h-11.819v-6.256c0-2.786,0-7.65-2.089-9.739
                              c-1.387-2.081-4.172-2.081-8.341-2.081H292.93v18.077h-11.82v-49.369h26.421c5.559,0,10.426,0,13.909,2.084
                              c3.474,2.088,6.254,5.565,6.254,11.128c0,7.647-4.865,11.819-8.343,13.212C322.829,303.49,324.914,304.885,325.609,306.276z
                              M373.589,286.107h-27.122v9.04h26.424v9.737h-26.424v9.736h27.122v10.429H334.65V275.68h38.939V286.107z M402.791,325.05h-22.252
                              v-10.429h22.252c2.082,0,3.476,0,4.87-1.392c0.696-0.697,1.387-2.085,1.387-3.477c0-1.394-0.691-2.778-1.387-3.475
                              c-0.698-0.695-2.091-1.391-4.176-1.391c-11.126-0.696-24.337,0-24.337-15.296c0-6.954,4.172-14.604,16.689-14.604h22.945v11.819
                              h-21.554c-2.085,0-3.478,0-4.87,0.696c-1.387,0.697-1.387,2.089-1.387,3.478c0,2.087,1.387,2.783,2.778,3.473
                              c1.394,0.697,2.783,0.697,4.172,0.697h6.259c6.259,0,10.43,1.391,13.211,4.173c2.087,2.087,3.478,5.564,3.478,10.43
                              C420.869,320.179,414.611,325.05,402.791,325.05z M462.59,320.179c-2.778,2.785-7.648,4.871-14.604,4.871H425.74v-10.429h22.245
                              c2.087,0,3.481,0,4.87-1.392c0.693-0.697,1.391-2.085,1.391-3.477c0-1.394-0.698-2.778-1.391-3.475
                              c-0.696-0.695-2.085-1.391-4.172-1.391c-11.122-0.696-24.337,0-24.337-15.295c0-6.609,3.781-12.579,13.106-14.352
                              c1.115-0.154,2.293-0.253,3.583-0.253h22.948v11.819h-15.3h-5.561h-0.696c-2.087,0-3.476,0-4.865,0.696
                              c-0.7,0.697-1.396,2.089-1.396,3.478c0,2.087,0.696,2.783,2.785,3.473c1.389,0.697,2.78,0.697,4.172,0.697h0.691h5.565
                              c3.039,0,5.337,0.375,7.44,1.114c1.926,0.697,8.302,3.549,9.728,10.994c0.124,0.78,0.215,1.594,0.215,2.495
                              C466.761,313.925,465.37,317.401,462.59,320.179z"/>
                          </g>
                        </svg>
                    }
                    <div>
                      <p class="font-medium text-sm text-blue-800">
                        {{ m.brand | uppercase }} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {{ m.last4 }}
                      </p>
                      <p class="text-xs text-blue-600">Scade: {{ m.exp_month }}/{{ m.exp_year }}</p>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <button class="btn btn-xs bg-red-600 hover:bg-red-700 text-white border-0 shadow"
                            (click)="removeSavedMethod(m.id)">
                      Rimuovi
                    </button>
                  </div>
                </div>
              }
            }
          </div>

          <p class="text-xs text-blue-500 mt-2">
            Carte di test Stripe:
          </p>
          <p class="text-xs text-blue-500 mt-2">
            Visa: 4242 4242 4242 4242
          </p>
          <p class="text-xs text-blue-500 mt-2">
            Mastercard: 5555 5555 5555 4444 (oppure 5200 8282 8282 8210)
          </p>
          <p class="text-xs text-blue-500 mt-2">
            American Express: 3782 822463 10005
          </p>
        </div>
      </div>
      @if (addMethodModalOpen) {
        <div class="fixed inset-0 z-[90] flex items-center justify-center p-4" (click)="closeAddMethodModal()">
          <div class="absolute inset-0 bg-black/30 backdrop-blur-sm"></div>
          <div class="relative bg-white rounded-2xl border border-blue-200 shadow-2xl w-full max-w-lg p-6"
              (click)="$event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
              <h4 class="text-xl font-bold text-blue-900">Aggiungi metodo di pagamento</h4>
              <button class="btn btn-ghost btn-sm" (click)="closeAddMethodModal()">‚úï</button>
            </div>
            <div id="payment-element" class="p-3 bg-blue-50/70 border border-blue-200 rounded-xl"></div>
            <div class="mt-5 flex gap-3">
              <button class="btn flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 border-none rounded-xl"
                      (click)="closeAddMethodModal()">Annulla</button>
              <button class="btn flex-1 bg-blue-600 hover:bg-blue-700 text-white border-none rounded-xl"
                      (click)="confirmAddMethod()" [disabled]="addingMethod">
                @if (addingMethod) { <span class="loading loading-spinner loading-sm"></span> } Salva
              </button>
            </div>
            <p class="text-xs text-blue-500 mt-3">
              I dati sono gestiti da Stripe. In test mode nessun addebito reale.
            </p>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Bottom Section - Statistics -->
  <div class="mt-8">
    <div class="card bg-white border border-blue-100 shadow-2xl">
      <div class="card-body bg-gradient-to-br from-blue-50 via-white to-sky-50 rounded-2xl">
        <h2 class="card-title text-2xl mb-4 text-blue-900">
          Statistiche di Viaggio
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="stat bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105">
            <div class="stat-figure text-blue-600">
              <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center shadow-lg">
                <span class="text-2xl">‚úàÔ∏è</span>
              </div>
            </div>
            <div class="font-bold text-blue-800">Voli Totali</div>
            <div class="stat-value text-3xl font-black text-blue-700">{{ passengerStatistics?.totalFlights }}</div>
          </div>
          <div class="stat bg-gradient-to-br from-sky-50 to-sky-100 border-2 border-sky-200 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105">
            <div class="stat-figure text-sky-600">
              <div class="w-12 h-12 bg-sky-600 rounded-full flex items-center justify-center shadow-lg">
                <span class="text-2xl">üåç</span>
              </div>
            </div>
            <div class="font-bold text-sky-800">Paesi Visitati</div>
            <div class="stat-value text-3xl font-black text-sky-700">{{ passengerStatistics?.visitedCountries }}</div>
          </div>
          <div class="stat bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105">
            <div class="stat-figure text-blue-600">
              <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center shadow-lg">
                <span class="text-2xl">üèÜ</span>
              </div>
            </div>
            <div class="font-bold text-blue-800">Livello</div>
            <div class="stat-value text-3xl font-black text-blue-700">{{ currentLevel || '‚Äî' }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  @if (isPhotoUpdatePopupOpen) {
    <div 
      class="fixed inset-0 z-[100] flex items-center justify-center p-4 photo-popup-overlay"
      (click)="closePhotoUpdatePopup()">
      <div class="absolute inset-0 bg-gradient-to-br from-blue-900/40 to-blue-800/50 backdrop-blur-md"></div>
      <div 
        class="relative bg-white/95 backdrop-blur-xl border border-blue-200/50 rounded-2xl shadow-2xl p-8 w-[500px] max-w-[calc(100vw-2rem)] mx-4 transform transition-all duration-300 hover:shadow-3xl max-h-[90vh] overflow-hidden photo-popup-container"
        (click)="$event.stopPropagation()">
        <button 
          (click)="closePhotoUpdatePopup()"
          class="absolute top-4 right-4 btn btn-ghost btn-sm btn-circle text-blue-600 hover:bg-blue-100 z-10">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <div class="text-center mb-8">
          <h2 class="text-2xl font-bold text-blue-900 mb-2">Aggiorna Foto Profilo</h2>
          <p class="text-blue-600">Scegli una nuova immagine per il tuo profilo</p>
        </div>
        <div class="space-y-6">
          <div class="text-center">
            <div class="avatar">
              <div class="w-32 h-32 rounded-full overflow-hidden border-4 border-blue-200 shadow-xl mx-auto relative">
                @if (!previewLoaded) {
                  <div class="w-full h-full bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center z-10">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-blue-400">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                    </svg>
                  </div>
                }
                <img
                  alt="Anteprima foto profilo"
                  [src]="photoPreview || getPhotoUrl()"
                  (load)="onPreviewLoad()"
                  (error)="onPreviewError()"
                  class="w-full h-full object-cover absolute inset-0 transition-opacity duration-300"
                  [class.opacity-100]="previewLoaded"
                  [class.opacity-0]="!previewLoaded" />
              </div>
            </div>
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text text-blue-800 font-semibold">Seleziona nuova foto</span>
            </label>
            <input 
              type="file" 
              #fileInput
              (change)="onFileSelected($event)"
              accept="image/*"
              class="file-input file-input-bordered w-full bg-white/80 backdrop-blur-sm border-2 border-blue-200 focus:border-blue-400 hover:border-blue-300 rounded-xl file-input-blue" />
            <label class="label">
              <span class="label-text-alt text-blue-600">Formati supportati: JPG, PNG, GIF (max 5MB)</span>
            </label>
          </div>
          <div class="flex gap-4 pt-4">
            <button 
              (click)="closePhotoUpdatePopup()"
              class="btn flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 border-none rounded-xl font-semibold">
              Annulla
            </button>
            <button 
              (click)="updateProfilePhoto()"
              [disabled]="!selectedFile || isUploading"
              class="btn flex-1 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white border-none rounded-xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
              @if (isUploading) {
                <span class="loading loading-spinner loading-sm"></span>
                Caricamento...
              } @else {
                Aggiorna Foto
              }
            </button>
          </div>
        </div>
      </div>
    </div>
  }
</div>
